# Screenshot Compositor

The screenshot compositor is a high-level DSL for manipulating images for use as screenshots for the App or Play Store. It can be invoked using the `promo_screenshots` action from a Fastfile. It's not designed for use from the command line.

## Getting Started

Calling it looks something like this:

``` ruby
promo_screenshots(
    orig_folder: 'screenshots',
    metadata_folder: 'metadata',
    output_folder: 'promo_screenshots',
    force: true,
)
```

Here's what's going on there:

**`orig_folder`**

This argument is a path to the directory containing the screenshots, typically generated by `screenshot` (on iOS) or `screengrab` (on Android). This directory should contain subdirectories named after locales.

**`metadata_folder`**

This argument is a path to the directory containing any metadata, such as localized strings for use on the final screenshots. This directory should contain subdirectories named after locales. 

> Note: The tool will automatically check these directories, and will be default use any locales found in both directories.

**`metadata_folder`**

This argument is a path to the destination directory for any produced images.

**`force`**

By default, this tool will prompt the developer before overwriting any existing screenshots. This argument overrides that, for use in CI or development.

**`config_file`** (optional)

The tool uses a `.json` file for configuration. By default, the tool will attempt to use a file called `screenshots.json` in the same directory as the `Fastfile`. If your file has a different name, you'll need to use this argument.

## Sample Implementations

The following sample implementations provide a good example of how to create a configuration file:

- [WordPress Android](https://github.com/wordpress-mobile/WordPress-Android/blob/develop/fastlane/screenshots.json)

## Creating a configuration file

The `.json` configuration file contains all the information needed for the compositor to do its work. It has three main sections:

- Preamble
- Devices
- Entries

Here's how each of those work:

### Preamble

The preamble is a set of top-level key-value pairs that apply to every screenshot. The keys include:

**`version`**

This is the version of the file format. This is currently unused by the compositor, but in future versions, will be able to detect backwards-incompatible files and refuse to process them.

**`background_color`**

This key defines the default background color of each screenshot. This must be any CSS-compatible color, such as `red` or `#cccccc`.

**`stylesheet`**

This key defines the default stylesheet used for text formatting. It should be a path to the stylesheet, either absolute, or relative to the configuration file.

A sample stylesheet looks like this:

```css
* {
    font-family: 'NotoSans';
    color: black;
}

strong {
    font-family: 'NotoSans-Bold';
}

```

The drawing engine has limited support for rich text, so use it sparingly. The folllowing CSS properties are known to work:

- `font-family`
- `color`
- `text-decoration`

### Devices

The device list specifies a set of reusable device frames for the compositor. This takes the form of an array of hashes, each one looking something like:


```json
{
    "name": "Pixel 2 XL",
    "canvas_size": [1080,1920],
    "text_size": [1024, 319],
    "text_offset": [0, 0],
    "font_size": "70px",
    "screenshot_size": [740, 1480],
    "screenshot_offset": [170, 440],
    "device_frame": "playstoreres/assets/pixel-2-xl.svg",
    "device_frame_size": [833, 1708],
    "device_frame_offset": [124, 317]
},
```

Here's what the keys do:

**`name`**

This is both a human-readable string corresponding to the name of the device, and a key used to identify the device for each entry.

**`canvas_size`**

Sets the output dimensions of the final image. This must be provided as an array with two values corresponding to the width and height, respectively.

**`text_size`**

Sets the dimensions of the screenshot text bounding box. Text will never overflow this box. If the size is too small, the compositor will crash saying it was unable to draw the text in an area this small. This must be provided as an array with two values corresponding to the width and height, respectively. The text will be horizontally centered and vertically aligned top within the bounding box.

**`text_offset`** (optional)

Sets the origin of the screenshot text bounding box. This must be provided as an array with two values corresponding to the x and y coordinates, respectively.  This value is optional, `[0, 0]` will be used if no value is provided.

**`font_size`**

Sets the font size for the screenshot text. If this value is too large, the compositor will crash saying it was unable to draw the text within the bounding box specifed in `text_size`.*

**`screenshot_size`**

Sets the dimensions of the original screenshot image within the final image. This must be provided as an array with two values corresponding to the width and height, respectively. The original screenshot image will be automatically resized to these dimensions.

**`screenshot_offset`**

Sets the origin of the original screenshot image.This must be provided as an array with two values corresponding to the x and y coordinates, respectively.  This value is optional; `[0, 0]` will be used if no value is provided.

**`device_frame`**

A path to the device frame image (if applicable). This path can be absolute or relative to the configuration file.

**`device_frame_size`**

Sets the dimensions of the device frame image within the final image. This must be provided as an array with two values corresponding to the width and height, respectively. The original device frame image will be automatically resized to these dimensions.

**`device_frame_offset`**

Sets the origin of the device frame image. This must be provided as an array with two values corresponding to the x and y coordinates, respectively.


### Entries

Entries specify the set of output screenshots. This takes the form of an array of hashes, each one looking something like:

> Note: There is a 1:1 relationship between entries and the final screenshots. Note that it is not necessary to create a set of entries for each locale – this is automatically handled for you.

Each entry looks something like this: 

```json
{
    "device": "Pixel 2 XL",
    "text": "playstoreres/metadata/%s/play_store_screenshot_7.html",
    "screenshot": "images/phoneScreenshots/1-build-and-manage-your-website.png",
    "background": "playstoreres/assets/backgrounds/01-background-phone.png",
    "attachments": [
        {
            "file": "playstoreres/assets/attachments/01-phone-website.png",
            "size": [740, 1480],
            "position": [170, 441]
        },
        {
            "file": "playstoreres/assets/attachments/01-phone-photos.png",
            "size": [918, 975],
            "position": [78, 832]
        }
    ]
}
```


**`device`**

This is the device name, as specified above in the `devices` section. If no device is found matching this name, the script will fail with an error.

**`filename`** (optional)

Allows you to customize the exported filename for this entry.

**`background`** (optional)

Specifies the path to a background image for this entry. This path can be absolute or relative to the configuration file. The background image **will not** be automatically resized, and it will be placed at `(0,0)`.  If not provided, the image will use the background color defined in the preamble.

**`screenshot`** (optional)

Specifies the path to the corresponding screenshot image for this entry. The path should be specified relative to a single locale directory.

> For instance: consider the following directory structure:
> ```
> screenshots
>   - ar
>    - phone
>    - tablet
>  - en
>    - phone
>    - tablet
>  - ru
>    - phone
>    - tablet
>```
>
> In this situation, we would specify `tablet/{image-name}.png` as the image for this entry.
>

**`text`** (optional)

Specifies the path to the caption for this entry. The caption should be a plain text file (HTML is fine). You should specify a locale placeholder using `%s`.

> For instance: consider the following directory structure:
> ```
> translations
>   - ar
>     - caption-1.txt
>  - en
>     - caption-1.txt
>  - ru
>     - caption-1.txt
>```
>
> In this situation, you could specify  `translations/%s/caption-1.txt`.
>

**`attachments`** (optional)

Specifies a list of attachments, which can be images or text. They are composited onto the final image in the order they appear in the configuration file. Attachments is specified as an array of hashes, with two different forms:

**Text Attachment**
```json
{
  "text": "metadata/{locale}/app_store_screenshot_1.txt",
  "size": [1242, 600],
  "position": [0, 620],
  "font-size": 144,
  "stylesheet": "appstoreres/assets/styles/first-screen-heading.css"
}
```
Text attachments use the following keys:

**`text`** 

Specifies the path to the text file for this attachment. The path should be specified relative to the configuration file, and can contain the `{locale}` placeholder to allow for localization.

**`size`** 

Sets the dimensions of the text bounding box within the final image. This must be provided as an array with two values corresponding to the width and height, respectively. If the size is too small, the compositor will crash saying it was unable to draw the text in an area this small. The text will be horizontally and vertically centered within the bounding box. 

**`position`** 

Sets the origin of the text bounding box within the final image. This must be provided as an array with two values corresponding to the x and y coordinates, respectively.

**`font-size`** 

Specifies the font size for the text of this attachment. If this number is too large, such that it doesn't fit into the bounding box described by the `size` key, the compositor will exit with an error message.

**`stylesheet`**

Specifies a stylesheet used for this attachment. It should contain a path to the stylesheet, either absolute, or relative to the configuration file.

**Image Attachment**
```json
{
  "file": "playstoreres/assets/attachments/01-image-name.png",
  "size": [2107, 1414],
  "position": [446, 586]
}
```

Image attachments use the following keys:

**`file`** 

Specifies the path to the attachment image. The path should be specified relative to the configuration file, and can contain the `{locale}` placeholder to allow for localization.

**`size`** 

Sets the dimensions of the attachment within the final image. This must be provided as an array with two values corresponding to the width and height, respectively.

**`position`** 

Sets the origin of the attachment within the final image. This must be provided as an array with two values corresponding to the x and y coordinates, respectively.

**`operations`** 

Specifies a set of operations to perform on the attachment prior to drawing it to the canvas. Operations run in the order they're specified within the configuration file. Operations are defined as an array of hashes. For example:

```json
{
  "type": "crop",
  "at": [0, 165],
  "to": [750, 800]
}
```

They use the following keys:

**`type`** 

Describes the type of operation.  Currently `crop` is the only operation that can be specified.

**Operations**

*Crop* allows you to crop the image using two keys:

**`at`** 

Specifies the origin point crop bounding box. This must be provided as an array with two values corresponding to the x and y coordinates, respectively.

**`to`** 

Specifies the dimensions of the crop bounding box. This must be provided as an array with two values corresponding to the width and height, respectively.
